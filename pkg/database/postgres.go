package database

import (
	"fmt"
	"strconv"
	"time"

	env "github.com/csye7125-su24-team06/webapp-cve-consumer/internal"
	"github.com/jackc/pgx/v5/pgconn"
	"github.com/sirupsen/logrus"
	"gorm.io/driver/postgres"
	"gorm.io/gorm"
	"gorm.io/gorm/logger"
	"gorm.io/gorm/schema"
)

func InitPostgres() {
	err := connect()
	HandleConnectionError(err)
}

func IsConnectionError(err error) bool {
	_, ok := err.(*pgconn.ConnectError)
	return ok
}

func HandleConnectionError(err error) {
	if err != nil && IsConnectionError(err) {

		postgresRetryCount, _ := strconv.Atoi(env.GetEnvOrDefault("POSTGRES_RETRY_COUNT", "100"))
		postgresRetryBackoffSeconds, _ := strconv.Atoi(env.GetEnvOrDefault("POSTGRES_RETRY_BACKOFF_SECONDS", "6"))

		// Retry connecting to the database
		logrus.Printf("Retrying database connection with retry count: %v", postgresRetryCount)

		for i := 0; i < postgresRetryCount; i++ {
			env.DatabaseConnectionRetries.Inc()
			err = connect()
			if err == nil {
				return
			} else {
				logrus.Printf("Database connection failed. Retry count: %v. Waiting %v seconds and retrying...", i, postgresRetryBackoffSeconds)
				time.Sleep(time.Duration(postgresRetryBackoffSeconds) * time.Second)
			}
		}

		// If the database connection fails after the retries, the application will exit
		logrus.Fatalf("Database connection failed after %v retries", postgresRetryCount)
	}
}

func connect() error {
	dsn := fmt.Sprintf("host=%v user=%v password=%v dbname=%v port=%v",
		env.GetEnvOrDefault("DB_HOST", "localhost"),
		env.GetEnvOrDefault("DB_USER", ""),
		env.GetEnvOrDefault("DB_PASSWORD", ""),
		env.GetEnvOrDefault("DB_DATABASE", "database"),
		env.GetEnvOrDefault("DB_PORT", "5432"))

	db, err := gorm.Open(postgres.Open(dsn), &gorm.Config{
		Logger: logger.Default.LogMode(logger.Silent),
		NamingStrategy: schema.NamingStrategy{
			TablePrefix: "cve.",
		},
	})

	if err != nil {
		return err
	}

	DataSource = db
	logrus.Println("Connected to database")
	return nil
}
